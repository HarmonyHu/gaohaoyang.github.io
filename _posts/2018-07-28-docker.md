---
layout: post
title: docker的使用
categories: Linux
tags: Linux docker
---

* content
{:toc}
## 一、安装和配置

1. 安装docker

   `sudo apt-get install docker-io`

2. 配置用户组

   `sudo usermod -aG docker USER_NAME` ：避免每次使用特权身份，重新登录生效

3. 查看docker信息

   `docker info`



## 二、镜像（image)

1. 获取镜像

   `docker pull NAME[:TAG]`: NAME表示镜像名称，TAG表示标签（通常是版本号）

   ├──`docker pull ubuntu:14.04`：  下载ubuntu 14.04 docker  
   ├──`docker pull ubuntu`： 没有指定标签，则下载最新，相当于ubuntu:latest  
   └──`docker pull hub.c.163.com/public/ubuntu:14.04`: 指定路径下载镜像

2. 列出所有镜像

   `docker images` : 列出镜像信息

   ```bash
   $ docker images
   REPOSITORY          TAG         IMAGE ID            CREATED             SIZE
   ubuntu              16.04       4a689991aa24        11 days ago         116 MB
   ubuntu              latest      ea4c82dcd15a        11 days ago         85.8 MB
   hub.c.163.com/public/ubuntu   14.04  2fe5c4bba1f9   2 years ago         237 MB
   ```

3. 对镜像添加标签，同时也起到类似软链接的作用

   `docker tag ubuntu:16.04 myubuntu:16.04`

4. 查看某个镜像的详细信息

   `docker inspect ubuntu:16.04`

5. 查看某个镜像的创建历史

   `docker history ubuntu:16.04`

6. 删除镜像

   `docker rmi myubuntu:latest` : 删除某个镜像，如果image id存在多个，则只是删除一个标签

   `docker rmi 4a68999` : 删除image id为4a68999xxxx的所有镜像

   `docker rmi -f ubuntu:14.04` : 强制删除某个镜像，如果存在容器使用该镜像时正常删除会报错

7. 存储镜像和载入镜像

   `docker save -o ubuntu_14.04.tar ubuntu:14.04` : 存储镜像

   `docker load < ubuntu_14.04.tar` : 导入镜像

   └──`docker load --input ubuntu_14.04.tar`

## 三、创建镜像

#### 基于已有镜像的容器创建

1. 启动镜像，修改后退出，如下：

   ```bash
   $ docker run -it ubuntu:16.04 /bin/bash
   root@19e28671fe8d:/# touch test
   root@19e28671fe8d:/# exit
   exit
   $ 
   ```

2. 提交镜像

   `docker commit [OPTIONS] CONTAINER [REPOSITORY:TAG]`

   `docker commit -m "Add test file" -a "Docker Newbee" 19e28671fe8d mydocker:0.1`

   `-m, --message=` : 提交的消息记录

   `-a, --author=` : 作者

#### 基于本地模板导入

下载模板压缩包，然后导入，如下：

`cat ubuntu-14.04-x86_64-minimal.tar.gz | docker import - ubuntu:14.04`

#### 使用Dockerfile创建镜像

###### 指令说明

* FROM

  制定所创建镜像的基础镜像，如果本地不存在，则默认会去Docker Hub下载指定镜像。格式为`FROM<image>`，或`FROM<image>:<tag>`,或`FROM<image>@<digest>`。 注意：任何Dockerfile中的第一条指令必须为FROM指令，并且，如果在同一个Dockerfile中创建多个镜像，可以使用多个FROM指令（每个镜像一次）。比如：

  ```dockerfile
   FROM centos
   FROM centos:latest
  ```

* MAINTAINER

  指定维护者信息，格式为`MAINTAINER<name>` ，该信息会写入生成镜像的Author属性域中。比如：

  ```dockerfile
  MAINTAINER test test@example.com
  ```

* RUN

  运行指定命令，格式为`RUN<command>`或`RUN ["executable", "param1" , "param2"]`。注意 后一个指令会被解析成Json数组。因此必须使用双引号。 注意： 前者默认将在shell终端中运行命令，即`/bin/sh -c`；后者则使用exec执行，不会启动shell环境。举例：

  ```dockerfile
  RUN apt-get update \
  	&& apt-get install -y libsnappy-dev libgoogle-glog-dev \
  	&& rm -rf /var/cache/apt
  RUN ["/bin/bash", "-c", "echo hello"]
  ```

* CMD
  启动容器时默认执行的命令，支持如下3种形式：

  `CMD ["executable","param1","param2"]` 使用exec执行，是推荐使用的。
  `CMD command param1 param2` 在/bin/sh中执行，提供给需要交互的应用。
  `CMD ["param1" ,"param2"]` 提供给ENTRYPOINT的默认参数。 

  举例：

  ```dockerfile
  CMD ["/bin/bash", "/usr/local/nginx/sbin/nginx", "-c", "/usr/local/nginx/conf/nginx.conf"]
  ```

  注意：每个Dodckerfile 只能有一条CMD命令，如果指定了多条命令，只有最后一条会被执行。另外CMD会被`docker run -it test /bin/bash`中的`/bin/bash`覆盖。

* LABEL

  指定生成镜像的元数据标签信息，格式为`LABEL <KEY>=<VALUE> .....` ，比如：
  `LABEL version = "1.0"` 
  `LABEL description = "This text illustrates ...."`

* EXPOSE

  声明镜像内服务所监听的端口。 
  格式为`EXPOSE <port > [<port> ... ]` ，比如：
  `EXPOSE 22 80 8443` 
  **注意：**该指令只能声明作用，并不会自动完成端口映射。

* ENV

  指定环境变量，在镜像生成过程中会被后续RUN指令使用，在镜像启动的容器中也存在。 
  格式为：`ENV<key><value>`或`ENV<key> = <value> ...`，比如：

  ```dockerfile
  ENV PG_MAJOR 9.3
  ENV PATH /usr/local/postgres-$PG_MAJOR/bin:$PATH
  ```

* ADD

  格式为：`ADD <src> <dest>`，赋值指定的`< src >` 路径下的内容到容器中的`<dest>`路径下，`<src>`可以为URL；如果为tar文件，会自动解压到`<dest>`路径下；支持正则格式。比如：`ADD *.c /code/`

* COPY

  格式为：`COPY <src> <dest>`，复制本地主机的<src>路径下的内容到镜像中的<dest>路径下；目标路径不存在则自动创建；支持正则格式；一般情况下推荐使用COPY，而不是ADD

* ENTRYPOINT

  指定镜像的默认入口命令，该入口命令会在启动容器时作为根命令执行，所有传入值作为该命令的参数。 
  支持两种格式： 
  `ENTRYPOINT ["executable" , "param1" , "param2"]`，由exec调用执行

  `ENTRYPOINT command param1 param2`，由shell 执行

  注意：每个Dockerfile只能有一个ENTRYPOINT，当指定多个时候，只有最后一个有效。在运行时可以被`--entrypoint`覆盖，如`docker run --entrypoint`。

* VOLUME

  创建一个数据卷挂在点。 格式为:`VOLUME ["/data"]` 
  可以从本地主机或其他容器挂载数据卷，一般用来存放数据库和需要保存的数据等。

* USER

  指定运行容器时的用户名或UID，格式为：`USER daemon`。当服务不需要管理员权限时，可以通过该命令指定用户名。

* WORKDIR

  为后续RUN、CMD和ENTRYPOINT指令配置工作目录。 
  格式为：`WORKDIR /path/to/workdir`

* ARG

  指定镜像内使用的参数（例如版本号信息等）

* ONBUILD

  配置当前所创建的镜像作为其他镜像的基础镜像时，所执行的创建操作指令

* STOPSIGNAL

  容器退出的信号值

* HEALTHCHECK

  如何进行健康检查

###### 范例文件

```dockerfile
## Set the base image to CentOS  基于centos镜像
FROM centos
# File Author / Maintainer  作者信息
MAINTAINER test test@example.com
# Install necessary tools  安装一些依赖的包
RUN yum install -y pcre-devel wget net-tools gcc zlib zlib-devel make openssl-devel
# Install Nginx  安装nginx
ADD http://nginx.org/download/nginx-1.8.0.tar.gz .  # 添加nginx的压缩包到当前目录下
RUN tar zxvf nginx-1.8.0.tar.gz  # 解包
RUN mkdir -p /usr/local/nginx  # 创建nginx目录
RUN cd nginx-1.8.0 && ./configure --prefix=/usr/local/nginx && make && make install  # 编译安装
RUN rm -fv /usr/local/nginx/conf/nginx.conf  # 删除自带的nginx配置文件
ADD http://www.apelearn.com/study_v2/.nginx_conf /usr/local/nginx/conf/nginx.conf  # 添加nginx配置文件
# Expose ports  开放80端口出来
EXPOSE 80
# Set the default command to execute when creating a new container  这里是因为防止服务启动后容器会停止的情况，所以需要多执行一句tail命令
ENTRYPOINT /usr/local/nginx/sbin/nginx && tail -f /etc/passwd
```

###### 创建镜像

命令为：`docker build [OPTION]`，该命令读取指定路径（包括子路径）下的Dockerfile，并将该路径的所有内容发给Docker服务端，由服务端来创建镜像。比如：`docker build -t build_repo/first_image /tmp/docker_builder/`，其中`build_repo/first_image`是标签，`/tmp/docker_builder/`是Dockerfile目录。

* 可以用`-f`指定Dockerfile路径

* 可以用`-t`指定生成的标签

* 可以通过`.dockerignore`指定忽略文件，如下：

  ```ini
  # comment
  */temp*
  */*/temp*
  tmp?
  ~*
  ```



## 四、容器(container)

#### 基本命令

1. 查看容器

   `docker ps` : 查看运行中的容器

   `docker ps -a` : 查看所有容器，包括没有运行的

2. 创建容器

   `docker create -it ubuntu:16.04` 

   `-i` : 保持标准输入打开

   `-t` : 分配伪终端

   `-d` : 后台运行docker

   `--name` : 指定容器的别名

   `--rm` : 容器退出后自动删除

3. 启动容器

   `docker start CONTAINER_ID|NAME` : 通过id或者name，启动容器；创建的容器或者终止的容器都可以start

   `docker restart CONTAINER_ID|NAME` : 终止并启动容器

4. 创建并启动容器

   `docker run -it ubuntu:14.04` : 进入容器，进行交互

   ├──`docker run ubuntu:14.04 /bin/echo hello world`： 在docker中运行程序后自动终止

   └──`docker run -d ubuntu /bin/sh -C "while true; do echo hello; done"`： 后台运行docker

5. 读取容器的输出信息

   `docker logs CONTAINER_ID|NAME`

6. 终止容器

   `docker stop CONTAINER_DI|NAME`: 终止容器

7. 进入容器

   `docker attach CONTAINER_ID|NAME` : 进入容器，可以进入一个正在运行的容器

   `docker exec -it CONTAINER_ID|NAME /bin/bash` : 进入容器，并执行bash终端

8. 删除容器

   `docker rm CONTAINER_ID|NAME` : 删除退出或终止的容器，运行中的容器加`-f`强制删除

9. 导出容器和导入容器 （这里与镜像类似，但没有历史记录，体积较小）

   `docker export -o mycontainer.tar CONTAINER_ID|NAME` : 导出容器

   `docker import mycontainer.tar - test/ubuntu:0.01` : 导入容器

#### 数据管理

1. 创建数据卷

   `docker run -it -v /dbdata --name dbdata ubuntu` : 创建/dbdata数据卷

   `docker run -it -v /home/tmp:/tmp ubuntu:14.04` : 前者是本地目录，后者是映射到容器的数据卷

2. 数据卷共享

   `docker run -it --volumes-from dbdata --name mydb ubuntu` :  共享访问dbdata中的数据卷

3. 删除数据卷

   `docker rm -v dbdata` : 删除容器，及其数据卷；没有`-v`参数，数据卷不会被删除

4. 备份数据卷

   `docker run --volume-from dbdata -v $(pwd):/backup --name worker ubuntu:14.04 tar cvf /backup/backup.tar /dbdata`

## 五、仓库 （Repository)

* Docker官方仓库：<https://hub.docker.com>
* `docker search ubuntu` : 搜寻仓库中的镜像，ubuntu是搜寻关键字
* `docker pull index.tenxcloud.com/<namespace>/<repository>:<tag>` : 指定服务器下载镜像

