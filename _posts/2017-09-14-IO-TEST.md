---
layout: post
title:  linux下磁盘分析
categories: 硬盘
tags: 硬盘 linux
---

* content
{:toc}

## 特殊磁盘文件

/dev/null  ： 在类Unix系统中，/dev/null，或称空设备，是一个特殊的设备文件，它丢弃一切写入其中的数据（但报告写入操作成功），读取它则会立即得到一个EOF。
在程序员行话，尤其是Unix行话中，/dev/null 被称为位桶(bit bucket)或者黑洞(black hole)。空设备通常被用于丢弃不需要的输出流，或作为用于输入流的空文件。这些操作通常由重定向完成。

/dev/zero  ： 在类UNIX 操作系统中, /dev/zero 是一个特殊的文件，当你读它的时候，它会提供无限的空字符(NULL, ASCII NUL, 0x00)。
其中的一个典型用法是用它提供的字符流来覆盖信息，另一个常见用法是产生一个特定大小的空白文件。BSD就是通过mmap把/dev/zero映射到虚地址空间实现共享内存的。可以使用mmap将/dev/zero映射到一个虚拟的内存空间，这个操作的效果等同于使用一段匿名的内存（没有和任何文件相关）。

## 磁盘信息查看

* `df -h`:磁盘空间信息

```
[root@localhost ~]# df -h
文件系统               容量  已用  可用 已用% 挂载点
/dev/mapper/rhel-root   17G  7.7G  9.2G   46% /
devtmpfs               896M     0  896M    0% /dev
tmpfs                  912M  144K  912M    1% /dev/shm
tmpfs                  912M   17M  895M    2% /run
tmpfs                  912M     0  912M    0% /sys/fs/cgroup
/dev/sda2             1014M  165M  850M   17% /boot
/dev/sda1              200M  9.5M  191M    5% /boot/efi
tmpfs                  183M   20K  183M    1% /run/user/0
```
--------------------------------


* `fdisk -l`:磁盘分区信息

```
[root@localhost ~]# fdisk -l /dev/sda
WARNING: fdisk GPT support is currently new, and therefore in an experimental phase. Use at your own discretion.

磁盘 /dev/sda：21.5 GB, 21474836480 字节，41943040 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：gpt

#         Start          End    Size  Type            Name
 1         2048       411647    200M  EFI System      EFI System Partition
 2       411648      2508799      1G  Microsoft basic 
 3      2508800     41940991   18.8G  Linux LVM   
```

## SMART信息读取smartctl

* `smartctl -A /dev/sda`: 查看SMART信息 (SMART是硬盘内部关于硬盘健康度的信息)  

![](https://github.com/HarmonyHu/harmonyhu.github.io/raw/master/_posts/images/sata.jpg) 

## iostat监控io状态

* `iostat -d 2 10`: 每2秒采样1次，共采样10次

使用例子如下：  
```
[root@localhost ~]# iostat -d 2 10
Linux 3.10.0-514.el7.x86_64 (localhost.localdomain) 	2017年09月14日 	_x86_64_	(1 CPU)

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
fd0               0.00         0.00         0.00         28          0
sda              20.06       571.34        45.83  106141320    8514201
scd0              0.00         0.00         0.00         74          0
dm-0             15.59       340.03        39.69   63169947    7374396
dm-1              1.96         1.73         6.12     320756    1137596

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
fd0               0.00         0.00         0.00          0          0
sda             637.16      2546.45         4.37       4660          8
scd0              0.00         0.00         0.00          0          0
dm-0              0.00         0.00         0.00          0          0
dm-1              1.09         0.00         4.37          0          8
```
------------------------------------

更复杂的例子如下：  
```
[root@localhost Documents]# iostat -xmt /dev/sda
avg-cpu:%user  %nice  %system %iowait  %steal   %idle
        1.89   0.23   0.90    2.20      0.00    94.78
Device: rrqm/s  wrqm/s  r/s   w/s  rMB/s wMB/s avgrq-sz avgqu-sz  await r_await w_await svctm %util
sda     0.35    1.54   15.24  2.82  0.46 0.05     57.31     0.47  26.23   10.91  109.12  1.76  3.18
```
------------------------------------
该命令参数如下：  
```
-C 显示CPU使用情况
-d 显示磁盘使用情况
-k 以 KB 为单位显示
-m 以 M 为单位显示
-N 显示磁盘阵列(LVM) 信息
-n 显示NFS 使用情况
-p[磁盘] 显示磁盘和分区的情况
-t 显示终端和CPU的信息
-x 显示详细信息
-V 显示版本信息
```
-----------------------------------
该命令信息解读如下：  
```
rrqm/s: 每秒进行 merge 的读操作数目。即 delta(rmerge)/s
wrqm/s: 每秒进行 merge 的写操作数目。即 delta(wmerge)/s
r/s: 每秒完成的读 I/O 设备次数。即 delta(rio)/s
w/s: 每秒完成的写 I/O 设备次数。即 delta(wio)/s
rsec/s: 每秒读扇区数。
wsec/s: 每秒写扇区数。
rMB/s: 每秒读M字节数。
wMB/s: 每秒写M字节数。
avgrq-sz: 平均每次设备I/O操作的数据大小 (扇区)。delta(rsect+wsect)/delta(rio+wio)
avgqu-sz: 平均I/O队列长度。即 delta(aveq)/s/1000 (因为aveq的单位为毫秒)。
await: 平均每次设备I/O操作的等待时间 (毫秒)。即 delta(ruse+wuse)/delta(rio+wio)
svctm: 平均每次设备I/O操作的服务时间 (毫秒)。即 delta(use)/delta(rio+wio)
%util: 一秒中有百分之多少的时间用于 I/O 操作，或者说一秒中有多少时间 I/O 队列是非空的。
```
  
## 磁盘坏道检测

* `badblocks [-svw][-b <区块大小>][-o <输出文件>][磁盘装置][磁盘区块数][启始区块]`  

该命令参数如下：  
```
-b<区块大小> 指定磁盘的区块大小，单位为字节。
-o<输出文件> 将检查的结果写入指定的输出文件。
-s 在检查时显示进度。
-v 执行时显示详细的信息。
-w 在检查时，执行写入测试。
[磁盘装置] 指定要检查的磁盘装置。
[磁盘区块数] 指定磁盘装置的区块总数。
[启始区块] 指定要从哪个区块开始检查。
```

使用例子如下：
```
[root@localhost ~]# badblocks -v /dev/sda
正在检查从 0 到 20971519的块
Checking for bad blocks (read-only test): done                                                 
Pass completed, 0 bad blocks found. (0/0/0 errors)
```

## 磁盘读取速度验证hdparm

* `hdparm -t /dev/sda`:对磁盘sda的读取速度测试

```
[root@localhost ~]# hdparm -t /dev/sda

/dev/sda:
 Timing buffered disk reads: 1310 MB in  3.02 seconds = 433.65 MB/sec
```

## 磁盘块数据拷贝dd

* `dd if=/dev/sda iflag=direct bs=4k of=/dev/zero`:对磁盘进行块拷贝，结合iostat可以观察磁盘性能

```
[root@localhost ~]# dd if=/dev/sda iflag=direct bs=4k of=/dev/zero
^C记录了1077066+0 的读入
记录了1077065+0 的写出
4411658240字节(4.4 GB)已复制，93.9845 秒，46.9 MB/秒
```

参数详解如下：  
```
if =输入文件（或设备名称）。
of =输出文件（或设备名称）。
ibs = bytes 一次读取bytes字节，即读入缓冲区的字节数。
skip = blocks 跳过读入缓冲区开头的ibs*blocks块。
obs = bytes 一次写入bytes字节，即写入缓冲区的字节数。
bs = bytes 同时设置读/写缓冲区的字节数（等于设置ibs和obs）。
cbs = byte 一次转换bytes字节。
count = blocks 只拷贝输入的blocks块。
```

实用例子如下(将一个软盘拷贝到另一个软盘)：
```
要把一张软盘的内容拷贝到另一张软盘上，利用/tmp作为临时存储区。把源盘插入驱动器中，输入下述命令：
$ dd if =/dev/fd0 of = /tmp/tmpfile

拷贝完成后，将源盘从驱动器中取出，把目标盘插入，输入命令：
$ dd if = /tmp/tmpfile of =/dev/fd0 

软盘拷贝完成后，应该将临时文件删除：
$ rm /tmp/tmpfile 
```



## 附：

[fio 2.1.10下载](https://github.com/HarmonyHu/harmonyhu.github.io/raw/master/_posts/other/fio-2.1.10.tar.gz) 